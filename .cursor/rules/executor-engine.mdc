---
description:
globs:
alwaysApply: false
---
# Otto Execution Engine Guide

Otto's execution engine is a sophisticated async task scheduler with dependency resolution, parallel execution, and incremental build support.

## Core Components

### Task Scheduler ([src/executor/scheduler.rs](mdc:src/executor/scheduler.rs))
The main execution coordinator that:
- Resolves task dependencies using DAG algorithms
- Manages parallel execution with semaphores
- Handles file timestamp checking for incremental builds
- Classifies tasks by type (IO/CPU/Network bound)
- Captures and manages task output

### Workspace Management ([src/executor/workspace.rs](mdc:src/executor/workspace.rs))
Handles Otto's sophisticated directory structure:
```
~/.otto/
  otto-<hash>/                    # Project-specific workspace
    .cache/                       # Content-addressable script cache
    <timestamp>/                  # Run-specific directories
      tasks/taskname/
        script.sh                 # Executed script
        stdout.log, stderr.log    # Output capture
        output.json               # Structured outputs
        artifacts/                # Task artifacts
```

### Dependency Resolution ([src/cli/parse.rs](mdc:src/cli/parse.rs))
Otto supports multiple dependency types:
- **Task Dependencies**: `before`/`after` relationships
- **File Dependencies**: Input/output files with glob patterns
- **Transitive Resolution**: Automatically includes all required tasks
- **Circular Detection**: Prevents infinite dependency loops

## Key Features

### Parallel Execution
- Configurable concurrency limits (`-j` flag)
- Task type classification for optimal scheduling:
  - **IOBound**: Shell commands, file operations
  - **CPUBound**: Compilation, data processing
  - **NetworkBound**: Downloads, API calls
- Semaphore-based resource management

### Incremental Builds
- File timestamp comparison between inputs and outputs
- Automatic task skipping when outputs are up-to-date
- Glob pattern expansion for complex file dependencies
- Mixed task and file dependency support

### Output Management ([src/executor/output.rs](mdc:src/executor/output.rs))
- Separate stdout/stderr capture
- Structured JSON output for inter-task communication
- Real-time output streaming with task prefixes
- Artifact collection and storage

## Task Execution Flow

1. **Parsing**: Configuration loaded and validated
2. **DAG Construction**: Dependencies resolved into execution graph
3. **Scheduling**: Tasks queued based on dependency satisfaction
4. **Execution**: Parallel async execution with resource limits
5. **Monitoring**: Output capture and status tracking
6. **Completion**: Cleanup and result reporting

## Usage Patterns

### CLI Interface ([src/cli/parse.rs](mdc:src/cli/parse.rs))
- Dynamic help generation based on available tasks
- Multi-task execution: `otto task1 -a val1 task2 -b val2`
- Parameter validation and environment integration
- Global options: `-j`, `-o`, `-v`, `-T`

### Testing
- Extensive test coverage in [tests/](mdc:tests)
- File dependency integration tests: [tests/file_dependencies_integration_test.rs](mdc:tests/file_dependencies_integration_test.rs)
- Executor unit tests in [src/executor/scheduler.rs](mdc:src/executor/scheduler.rs)
