otto:
  api: 1
  tasks: [ci]
  envs:
    VERSION: "$(git describe --tags --always --dirty 2>/dev/null || echo 'dev')"
    GIT_SHA: "$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"

tasks:
  # Whitespace linting
  lint:
    help: "Run whitespace linting"
    bash: |
      whitespace -r

  # Code quality checks
  check:
    help: "Run all quality checks (compile, clippy, format)"
    bash: |
      echo "=== Checking compilation ==="
      cargo check --workspace --all-targets --all-features
      echo ""
      echo "=== Running Clippy ==="
      cargo clippy --workspace --all-targets --all-features -- -D warnings
      echo ""
      echo "=== Checking format ==="
      cargo fmt --all --check
      echo ""
      echo "âœ… All checks passed!"

  # Run tests
  test:
    help: "Run all tests"
    bash: |
      cargo test --workspace --all-features

  # Run coverage tests and output data
  cov:
    help: "Run tests with coverage via llvm-cov"
    after: [cov-report]
    bash: |
      echo "Running tests with coverage..."

      JSON_FILE="$OTTO_TASK_DIR/coverage.json"

      # Run coverage
      TEST_FAILED=0
      if ! cargo llvm-cov --workspace --all-features --json --output-path "$JSON_FILE" 2>&1; then
        TEST_FAILED=1
      fi

      # Validate JSON was created
      if [ ! -s "$JSON_FILE" ] || ! jq -e '.data[0].totals' "$JSON_FILE" >/dev/null 2>&1; then
        echo "Tests failed - no coverage data generated"
        exit 1
      fi

      # Generate HTML report
      cargo llvm-cov report --html --output-dir target/llvm-cov/html >/dev/null 2>&1 || true

      # Output data for cov-report
      otto_set_output "json_path" "$JSON_FILE"
      otto_set_output "test_failed" "$TEST_FAILED"
      otto_set_output "lines_pct" "$(jq -r '.data[0].totals.lines.percent // 0' "$JSON_FILE")"
      otto_set_output "lines_cov" "$(jq -r '.data[0].totals.lines.covered // 0' "$JSON_FILE")"
      otto_set_output "lines_tot" "$(jq -r '.data[0].totals.lines.count // 0' "$JSON_FILE")"
      otto_set_output "funcs_pct" "$(jq -r '.data[0].totals.functions.percent // 0' "$JSON_FILE")"
      otto_set_output "funcs_cov" "$(jq -r '.data[0].totals.functions.covered // 0' "$JSON_FILE")"
      otto_set_output "funcs_tot" "$(jq -r '.data[0].totals.functions.count // 0' "$JSON_FILE")"
      otto_set_output "regions_pct" "$(jq -r '.data[0].totals.regions.percent // 0' "$JSON_FILE")"

  # Display coverage report (runs after cov)
  cov-report:
    help: "Display coverage report"
    params:
      --fail-under:
        default: "0"
        help: "Minimum line coverage percentage (0 = no threshold)"
      --json:
        default: "false"
        help: "Output raw JSON coverage data"
      --details:
        default: "false"
        help: "Show detailed per-file coverage"
    bash: |
      # Colors provided by otto builtins: RED, GREEN, YELLOW, BLUE, CYAN, MAGENTA, BOLD, DIM, NC

      color_pct() {
        local pct=$1
        local int_pct=${pct%.*}
        if [ "$int_pct" -ge 80 ]; then echo -e "${GREEN}${pct}%${NC}"
        elif [ "$int_pct" -ge 60 ]; then echo -e "${YELLOW}${pct}%${NC}"
        else echo -e "${RED}${pct}%${NC}"; fi
      }

      # Get data from cov task
      JSON_PATH=$(otto_get_input "cov.json_path")
      TEST_FAILED=$(otto_get_input "cov.test_failed")
      LINES_PCT=$(printf "%.1f" "$(otto_get_input "cov.lines_pct")")
      LINES_COV=$(otto_get_input "cov.lines_cov")
      LINES_TOT=$(otto_get_input "cov.lines_tot")
      FUNCS_PCT=$(printf "%.1f" "$(otto_get_input "cov.funcs_pct")")
      FUNCS_COV=$(otto_get_input "cov.funcs_cov")
      FUNCS_TOT=$(otto_get_input "cov.funcs_tot")
      REGIONS_PCT=$(printf "%.1f" "$(otto_get_input "cov.regions_pct")")

      # Raw JSON mode
      if [ "${json}" = "true" ]; then
        cat "$JSON_PATH"
        exit $TEST_FAILED
      fi

      # Detailed per-file coverage
      if [ "${details}" = "true" ]; then
        echo -e "${BOLD}${CYAN}Per-file Coverage:${NC}"
        echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
        jq -r '.data[0].files[] | "\(.filename)|\(.summary.lines.percent // 0)|\(.summary.lines.covered // 0)|\(.summary.lines.count // 0)"' "$JSON_PATH" | \
        sort -t'|' -k2 -n | while IFS='|' read -r file pct covered total; do
          display=$(echo "$file" | sed 's|.*/src/||')
          [ ${#display} -gt 40 ] && display="...${display: -37}"
          int_pct=${pct%.*}
          if [ "$int_pct" -ge 80 ]; then color=$GREEN
          elif [ "$int_pct" -ge 60 ]; then color=$YELLOW
          else color=$RED; fi
          printf "  %-42s %b%6.1f%%%b %b(%d/%d)%b\n" "$display" "$color" "$pct" "$NC" "$DIM" "$covered" "$total" "$NC"
        done
        echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
        echo ""
      fi

      # Summary
      echo -e "${BOLD}${CYAN}Coverage Summary${NC}"
      echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
      echo -e "  ${BOLD}Lines:${NC}     $(color_pct $LINES_PCT)  ${DIM}(${LINES_COV}/${LINES_TOT})${NC}"
      echo -e "  ${BOLD}Functions:${NC} $(color_pct $FUNCS_PCT)  ${DIM}(${FUNCS_COV}/${FUNCS_TOT})${NC}"
      echo -e "  ${BOLD}Regions:${NC}   $(color_pct $REGIONS_PCT)"
      echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
      echo ""

      # Threshold check
      THRESHOLD_FAILED=0
      if [ "${fail_under}" != "0" ]; then
        LINES_INT=${LINES_PCT%.*}
        THRESHOLD_INT=${fail_under%.*}
        if [ "$LINES_INT" -lt "$THRESHOLD_INT" ]; then
          THRESHOLD_FAILED=1
          echo -e "${RED}${BOLD}âœ— Coverage ${LINES_PCT}% is below ${fail_under}% threshold${NC}"
        else
          echo -e "${GREEN}${BOLD}âœ“ Coverage ${LINES_PCT}% meets ${fail_under}% threshold${NC}"
        fi
        echo ""
      fi

      echo -e "${BLUE}Report:${NC} target/llvm-cov/html/index.html"

      [ "$TEST_FAILED" = "1" ] || [ "$THRESHOLD_FAILED" = "1" ] && exit 1 || true

  # Full CI pipeline
  ci:
    help: "Full CI pipeline (lint + check + test in parallel)"
    before: [lint, check, test]
    bash: |
      echo "âœ… All CI checks passed!"

  # Build documentation
  docs:
    help: "Build documentation"
    bash: |
      cargo doc --no-deps --workspace
      echo "âœ… Documentation built"

  # Validate example ottofiles
  examples:
    help: "Validate all example ottofiles parse correctly"
    bash: |
      echo "Validating example ottofiles..."
      failed=0
      for dir in examples/*/; do
        if [ -f "$dir/otto.yml" ] || [ -f "$dir/otto.yaml" ] || [ -f "$dir/.otto.yml" ]; then
          echo -n "Checking $(basename $dir)... "
          if cargo run --quiet --manifest-path=./Cargo.toml -- -o "$dir" --help > /dev/null 2>&1; then
            echo "âœ…"
          else
            echo "âŒ"
            failed=$((failed + 1))
          fi
        fi
      done
      if [ $failed -eq 0 ]; then
        echo ""
        echo "âœ… All examples valid!"
      else
        echo ""
        echo "âŒ $failed example(s) failed validation"
        exit 1
      fi

  # Quick validation
  quick:
    help: "Quick validation (check + test in parallel)"
    before: [check, test]
    bash: |
      echo "âœ… Quick checks passed!"

  # Pre-commit checks
  pre-commit:
    help: "Pre-commit checks (format, then run CI)"
    bash: |
      echo "=== Formatting Code ==="
      cargo fmt --all
      echo ""
      echo "=== Running CI Checks ==="
      otto ci
      echo ""
      echo "âœ… Ready to commit!"

  # Run everything
  all:
    help: "Run everything (ci + docs + examples in parallel)"
    before: [ci, docs, examples]
    bash: |
      echo ""
      echo "=== Summary ==="
      echo "âœ… All tests passed"
      echo "âœ… Clippy checks passed"
      echo "âœ… Format checks passed"
      echo "âœ… Documentation built"
      echo "âœ… Examples validated"
      echo ""
      echo "ðŸŽ‰ Everything looks great!"

  # Baseline verification
  baseline:
    help: "Run baseline verification (DO THIS BEFORE AND AFTER TUI CHANGES)"
    bash: |
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "Otto Baseline Verification"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "[1/3] Running cargo test..."
      if ! cargo test --quiet 2>&1 | tail -1; then
        echo "âŒ Tests failed!"
        exit 1
      fi
      echo "âœ… All tests passed"
      echo ""
      echo "[2/3] Building release binary..."
      if ! cargo build --release --quiet 2>&1; then
        echo "âŒ Build failed!"
        exit 1
      fi
      echo "âœ… Release binary built"
      echo ""
      echo "[3/3] Testing basic execution..."
      cd examples/ex1
      if ! ../../target/release/otto punch > /dev/null 2>&1; then
        echo "âŒ Basic execution failed!"
        exit 1
      fi
      echo "âœ… Basic execution works"
      cd ../..
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "âœ… BASELINE VERIFICATION PASSED"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "The system is working correctly."
      echo "Safe to proceed with TUI development."
      echo ""
      echo "Remember: Run 'otto baseline' after each TUI phase!"

  # Build release binaries
  build:
    help: "Build release binaries for all workspace members"
    bash: |
      cargo build --release --workspace
      echo "âœ… Release build complete for all workspace members"

  # Clean build artifacts
  clean:
    help: "Deep clean (cargo clean + remove all otto run artifacts)"
    bash: |
      echo "Cleaning cargo artifacts..."
      cargo clean
      echo ""
      echo "Cleaning otto run directories..."
      rm -rf .otto-run/
      find examples/ -type d -name ".otto-run" -exec rm -rf {} + 2>/dev/null || true
      echo ""
      echo "âœ… All cleaned!"

  # Install binary locally
  install:
    help: "Install otto binary locally via cargo"
    bash: |
      cargo install --path .
      echo "âœ… otto installed to ~/.cargo/bin"
