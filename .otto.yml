otto:
  api: 1
  tasks:
    - dev
  envs:
    VERSION: "$(git describe --tags --always --dirty 2>/dev/null || echo 'dev')"
    GIT_SHA: "$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"

tasks:
  # Development Setup
  dev:
    help: "Setup development environment (check Rust installation)"
    bash: |
      echo "ðŸ¦€ Otto Development Environment"
      echo ""
      echo "Rust version:"
      rustc --version
      echo ""
      echo "Cargo version:"
      cargo --version
      echo ""
      echo "âœ… Development environment ready!"
      echo ""
      echo "Quick commands:"
      echo "  cargo build          - Build debug"
      echo "  cargo test           - Run tests"
      echo "  cargo clippy         - Lint"
      echo "  cargo fmt            - Format"
      echo ""
      echo "Otto tasks:"
      echo "  otto ci              - Full CI pipeline"
      echo "  otto quick           - Fast validation"

  # Individual quality checks (for parallel execution)
  check:
    help: "Fast compile check"
    bash: |
      cargo check

  clippy:
    help: "Run Clippy linter"
    bash: |
      cargo clippy -- -D warnings

  fmt-check:
    help: "Check code formatting"
    bash: |
      cargo fmt -- --check

  test:
    help: "Run all tests"
    bash: |
      cargo test

  doc-build:
    help: "Build documentation"
    bash: |
      cargo doc --no-deps

  # Meta task: quick validation (3 things in parallel)
  quick:
    help: "Quick validation (check + test + fmt-check in parallel)"
    before: [check, test, fmt-check]
    bash: |
      echo "âœ… Quick checks passed!"

  # Meta task: CI pipeline (3 checks in parallel)
  ci:
    help: "Full CI pipeline (test + clippy + fmt-check in parallel)"
    before: [test, clippy, fmt-check]
    bash: |
      echo "âœ… All CI checks passed!"

  # Pre-commit workflow
  pre-commit:
    help: "Pre-commit checks (format, then run CI)"
    bash: |
      echo "=== Formatting Code ==="
      cargo fmt
      echo ""
      echo "=== Running CI Checks ==="
      otto ci
      echo ""
      echo "âœ… Ready to commit!"

  # Examples
  validate-examples:
    help: "Validate all example ottofiles parse correctly"
    bash: |
      echo "Validating example ottofiles..."
      failed=0
      for dir in examples/*/; do
        if [ -f "$dir/otto.yml" ] || [ -f "$dir/otto.yaml" ] || [ -f "$dir/.otto.yml" ]; then
          echo -n "Checking $(basename $dir)... "
          if cargo run --quiet --manifest-path=./Cargo.toml -- -o "$dir" --help > /dev/null 2>&1; then
            echo "âœ…"
          else
            echo "âŒ"
            failed=$((failed + 1))
          fi
        fi
      done
      if [ $failed -eq 0 ]; then
        echo ""
        echo "âœ… All examples valid!"
      else
        echo ""
        echo "âŒ $failed example(s) failed validation"
        exit 1
      fi

  # Complete validation (4 things in parallel)
  all:
    help: "Run everything (ci + doc + examples in parallel)"
    before: [ci, doc-build, validate-examples]
    bash: |
      echo ""
      echo "=== Summary ==="
      echo "âœ… All tests passed"
      echo "âœ… Clippy checks passed"
      echo "âœ… Format checks passed"
      echo "âœ… Documentation built"
      echo "âœ… Examples validated"
      echo ""
      echo "ðŸŽ‰ Everything looks great!"

  # Baseline verification tasks (for TUI development)
  baseline:
    help: "Run baseline verification (DO THIS BEFORE AND AFTER TUI CHANGES)"
    bash: |
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "Otto Baseline Verification"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "[1/3] Running cargo test..."
      if ! cargo test --quiet 2>&1 | tail -1; then
        echo "âŒ Tests failed!"
        exit 1
      fi
      echo "âœ… All tests passed"
      echo ""
      echo "[2/3] Building release binary..."
      if ! cargo build --release --quiet 2>&1; then
        echo "âŒ Build failed!"
        exit 1
      fi
      echo "âœ… Release binary built"
      echo ""
      echo "[3/3] Testing basic execution..."
      cd examples/ex1
      if ! ../../target/release/otto punch > /dev/null 2>&1; then
        echo "âŒ Basic execution failed!"
        exit 1
      fi
      echo "âœ… Basic execution works"
      cd ../..
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "âœ… BASELINE VERIFICATION PASSED"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "The system is working correctly."
      echo "Safe to proceed with TUI development."
      echo ""
      echo "Remember: Run 'otto baseline' after each TUI phase!"

  # Cleanup
  clean-all:
    help: "Deep clean (cargo clean + remove all otto run artifacts)"
    bash: |
      echo "Cleaning cargo artifacts..."
      cargo clean
      echo ""
      echo "Cleaning otto run directories..."
      rm -rf .otto-run/
      find examples/ -type d -name ".otto-run" -exec rm -rf {} + 2>/dev/null || true
      echo ""
      echo "âœ… All cleaned!"
