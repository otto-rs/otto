otto:
  api: 1
  jobs: 4
  tasks:
  - dev
  envs:
    # Define variables similar to Makefile
    CERTS_DIR: "./certs/tatari"

tasks:
  # Main comprehensive task that runs all checks
  all:
    help: "Run all development tasks: dev, unit-test, integration-test, type-check, lint"
    before: [dev, unit-test, integration-test, type-check, lint]

  # Development setup
  dev:
    help: "Install development dependencies using Poetry"
    bash: |
      #!/bin/bash
      poetry install

  # Testing tasks
  unit-test:
    help: "Run unit tests with pytest and coverage"
    before: [dev]
    envs:
      ENV: "ci"
    bash: |
      #!/bin/bash
      env ENV=ci poetry run pytest --junitxml=pytest.xml --cov=auth_svc tests/unit

  integration-test:
    help: "Run integration tests"
    before: [dev]
    bash: |
      #!/bin/bash
      poetry run pytest tests/integration

  # Code quality tasks
  type-check:
    help: "Run type checking with mypy"
    before: [dev]
    bash: |
      #!/bin/bash
      poetry run mypy

  lint:
    help: "Run linting with pre-commit hooks"
    before: [dev]
    bash: |
      #!/bin/bash
      poetry run pre-commit run --all-files

  # Key generation task (custom business logic)
  keygen:
    help: "Generate RSA key pairs for active and on_deck certificates"
    bash: |
      #!/bin/bash
      # Create separate directories for public and private keys
      mkdir -p ${CERTS_DIR}/public ${CERTS_DIR}/private

      # Generate active.pem
      # Generate active.pem private key and extract active.pem public key
      openssl genpkey -algorithm RSA -out ${CERTS_DIR}/private/active.pem -pkeyopt rsa_keygen_bits:2048
      openssl rsa -in ${CERTS_DIR}/private/active.pem -pubout -out ${CERTS_DIR}/public/active.pem

      # Generate on_deck.pem
      # Generate on_deck.pem private key and extract on_deck.pem public key
      openssl genpkey -algorithm RSA -out ${CERTS_DIR}/private/on_deck.pem -pkeyopt rsa_keygen_bits:2048
      openssl rsa -in ${CERTS_DIR}/private/on_deck.pem -pubout -out ${CERTS_DIR}/public/on_deck.pem

      echo "Private keys stored in ${CERTS_DIR}/private/"
      echo "Public keys stored in ${CERTS_DIR}/public/"

  # Cleanup task
  clean:
    help: "Clean build artifacts and caches"
    bash: |
      #!/bin/bash
      rm -rf build/ dist/ .venv/ .mypy_cache/ .pytest_cache/
      rm -rf *.egg-info
      rm -rf .coverage
      find . -name '__pycache__' -type d -exec rm -rf {} + 2>/dev/null || true
      find . -name '*.pyc' -type f -delete