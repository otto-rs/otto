otto:
  api: 1
  jobs: 4
  tasks:
  - dev
  envs:
    # Variables from Makefile using shell command evaluation
    GIT_DESCRIBE: "$(git describe --always --abbrev=7)"
    PYPI_USERNAME: "$(cat ~/.config/pip/pip.conf | grep extra-index-url | awk -F '[//|@]' '{print $3}' | awk -F '[:]' '{print $1}' 2>/dev/null || echo '')"
    PYPI_PASSWORD: "$(cat ~/.config/pip/pip.conf | grep extra-index-url | awk -F '[//|@]' '{print $3}' | awk -F '[:]' '{print $2}' 2>/dev/null || echo '')"
    LOCAL_DUMP_FILE: "./schema/local-db/media-planning-service-pgdump.tar.gz"

tasks:
  # Main comprehensive task
  all:
    help: "Run all development tasks: dev, unit-test, integration-test, type-check, lint"
    before: [dev, unit-test, integration-test, type-check, lint]

  # Development setup
  dev:
    help: "Install development dependencies using Poetry"
    bash: |
      #!/bin/bash
      poetry install

  # Testing tasks
  test:
    help: "Run all tests"
    before: [dev]
    bash: |
      #!/bin/bash
      poetry run pytest

  unit-test:
    help: "Run unit tests with coverage and JUnit XML output"
    before: [dev]
    bash: |
      #!/bin/bash
      poetry run pytest --junitxml=pytest.xml --cov=media_planning_service tests/unit --log-cli-level=CRITICAL

  integration-test:
    help: "Run integration tests (continues on failure)"
    before: [dev]
    bash: |
      #!/bin/bash
      poetry run pytest tests/integration -s || true

  # Code quality tasks
  type-check:
    help: "Run type checking with mypy"
    before: [dev]
    bash: |
      #!/bin/bash
      poetry run mypy

  lint:
    help: "Run linting with pre-commit hooks"
    before: [dev]
    bash: |
      #!/bin/bash
      poetry run pre-commit run --all-files

  # Server tasks
  run-rest:
    help: "Run the REST API server with auto-reload"
    before: [dev]
    bash: |
      #!/bin/bash
      poetry run uvicorn media_planning_service.rest.app:app --reload

  # Database operations
  get-postgres-dump:
    help: "Download the latest PostgreSQL dump from S3"
    bash: |
      #!/bin/bash
      LATEST_S3_DUMP_FILE=$(aws s3api list-objects-v2 --bucket "tatari-pg-dumps" --prefix 'media_planning_service' --query 'sort_by(Contents, &LastModified)[-1].Key' --output=text)
      DUMP_CHECK="${LOCAL_DUMP_FILE}-${LATEST_S3_DUMP_FILE}.check"

      echo "LATEST_S3_DUMP_FILE: $LATEST_S3_DUMP_FILE"
      echo "Downloading the latest pgdump from S3.."

      if [ -f "$DUMP_CHECK" ]; then
        echo "  dump file already exists"
      else
        aws s3 cp "s3://tatari-pg-dumps/$LATEST_S3_DUMP_FILE" "$LOCAL_DUMP_FILE"
        touch "$DUMP_CHECK"
      fi

  # Docker Compose operations
  docker-compose-build:
    help: "Build Docker Compose services"
    bash: |
      #!/bin/bash
      docker compose up --build -d

  docker-compose:
    help: "Start Docker Compose services with database dump"
    before: [get-postgres-dump, docker-compose-build]

  docker-compose-down:
    help: "Stop Docker Compose services"
    bash: |
      #!/bin/bash
      docker compose -f docker-compose.yaml down

  docker-compose-with-farnsworth-build:
    help: "Build Docker Compose services with Farnsworth"
    bash: |
      #!/bin/bash
      docker compose -f docker-compose.yaml -f docker-compose.farnsworth.yaml up --build -d

  docker-compose-with-farnsworth:
    help: "Start Docker Compose services with Farnsworth and database dump"
    before: [get-postgres-dump, docker-compose-with-farnsworth-build]

  docker-compose-with-farnsworth-down:
    help: "Stop Docker Compose services with Farnsworth"
    bash: |
      #!/bin/bash
      docker compose -f docker-compose.yaml -f docker-compose.farnsworth.yaml down

  docker-compose-clean:
    help: "Clean Docker containers and volumes for media-planning-service"
    bash: |
      #!/bin/bash
      echo "Deleting media-planning-service volumes and containers..."
      docker ps -a | grep 'media-planning-service' | awk -F ' ' '{print $1}' | xargs -I {} sh -c "docker rm -f {}" || true
      docker volume list | grep 'media-planning-service' | awk -F ' ' '{print $2}' | xargs -I {} sh -c "docker volume rm -f {}" || true

  # Database access
  psql:
    help: "Connect to PostgreSQL database in Docker container"
    bash: |
      #!/bin/bash
      docker exec -it media-planning-service-db-1 psql -U tatari media_planning_service

  # Development cleanup
  dev-clean:
    help: "Clean development-specific files"
    bash: |
      #!/bin/bash
      rm -f ${LOCAL_DUMP_FILE}-*.check

  # Main cleanup task
  clean:
    help: "Clean build artifacts and caches"
    before: [dev-clean]
    bash: |
      #!/bin/bash
      rm -rf build/ dist/ .venv/ .mypy_cache/ .pytest_cache/
      rm -rf *.egg-info
      rm -rf .coverage
      find . -name '*.pyc' -delete
      find . -name '__pycache__' -delete
