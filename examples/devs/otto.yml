# Otto configuration for Go devs project
# Translated from Makefile

otto:
  api: 1
  jobs: 4
  # Environment variables  
  envs:
    # Go environment setup
    HOME: "${HOME}"
    GOPATH: "${HOME}/go"
    GOMODCACHE: "${HOME}/go/pkg/mod"
    GOCACHE: "${HOME}/.cache/go-build"
    # Dynamic variables using shell commands
    VERSION: "$(git describe --tags --always --dirty)"
    BUILD: "$(git rev-parse HEAD)"

# Task definitions
tasks:
  # Main comprehensive task
  all:
    help: "Run all checks and build"
    before: [unit-test, type-check, lint, build]

  # Build the Go binary
  build:
    help: "Build the Go binary"
    action: |
      export GOPATH="${HOME}/go"
      export GOMODCACHE="${HOME}/go/pkg/mod"  
      mkdir -p dist
      go build -o dist/devs cmd/devs/main.go

  # Run the built binary
  run:
    help: "Run the built binary"
    before: [build]
    action: |
      ./dist/devs 2> err.log

  # Testing related tasks
  unit-test:
    help: "Run unit tests with coverage"
    action: |
      export GOPATH="${HOME}/go"
      export GOMODCACHE="${HOME}/go/pkg/mod"
      go test -cover -coverprofile=coverage.txt ./...

  test:
    help: "Alias for unit-test"
    before: [unit-test]

  coverage:
    help: "Generate HTML coverage report"
    before: [unit-test]
    action: |
      go tool cover -html=coverage.txt

  # Code quality tasks
  fmt:
    help: "Format Go source code"
    action: |
      SRC=$(find . -type f -name '*.go' -not -path "./vendor/*")
      if [ -n "$SRC" ]; then
        gofmt -l -w $SRC
      else
        echo "No Go source files found"
      fi

  type-check:
    help: "Run static analysis"
    action: |
      go run honnef.co/go/tools/cmd/staticcheck@v0.5.1 ./...

  lint:
    help: "Lint code (runs fmt)"
    before: [fmt]

  # Cleanup
  clean:
    help: "Clean build artifacts"
    action: |
      rm -rf dist/
      rm -rf .coverage 