# ottofile.yaml
otto:
  api: 1
  jobs: 16
  envs:
    PROJECT: "github.com/dmswe/ttha"
    GOCMD: "go"
    BINARY_NAME: "ttha"
    GOBUILD: "go build"
    GOINSTALL: "go install"
    GOCLEAN: "go clean"
    GOTEST: "go test"
    GOGET: "go get"
    GOLINT: "golint"
    GO_FILES: "$(find . -name '*.go' | grep -v _test.go)"
    GIT_COMMIT: "${GIT_COMMIT:-$(git rev-parse --short HEAD)}"

tasks:
  info:
    help: "Show help information"
    bash: |
      echo "Available tasks:"
      echo "  help         - Show this help"
      echo "  test         - Run tests"
      echo "  clean        - Clean project artifacts"
      echo "  lint         - Lint project code"
      echo "  dep          - Install dependencies"
      echo "  build-linux  - Build Linux artifact"
      echo "  build-mac    - Build macOS artifact"
      echo "  package      - Package source code"
      echo "  build-docker - Build docker image"
      echo "  fmt          - Format source code"

  test:
    help: "Run tests"
    bash: |
      ${GOTEST} ./... -v

  clean:
    help: "Clean project artifacts"
    bash: |
      echo "==> Clean project..."
      ${GOCLEAN}
      rm -f ${BINARY_NAME}
      rm -f ${BINARY_NAME}.tar.gz

  lint:
    help: "Lint project code"
    bash: |
      echo "==> Lint project..."
      ${GOLINT} ./...

  dep:
    help: "Install dependencies"
    bash: |
      echo "==> Installing dependencies..."
      ${GOGET} -v -d ./...
      ${GOGET} -u golang.org/x/lint/golint

  build-linux:
    help: "Build Linux artifact"
    before: [dep]
    envs:
      CGO_ENABLED: "0"
      GOOS: "linux"
      GOARCH: "amd64"
    bash: |
      echo "==> Build Linux artifact..."
      ${GOBUILD} -o ${BINARY_NAME} -v

  build-mac:
    help: "Build macOS artifact"
    before: [dep]
    envs:
      CGO_ENABLED: "0"
      GOOS: "darwin"
      GOARCH: "amd64"
    bash: |
      echo "==> Build OSX artifact..."
      ${GOBUILD} -o ${BINARY_NAME} -v

  package:
    help: "Package source code"
    before: [build-linux]
    bash: |
      echo "==> Package source code..."
      tar -czvf ${BINARY_NAME}.tar.gz ${BINARY_NAME}

  build-docker:
    help: "Build docker image with buildkit"
    envs:
      DOCKER_BUILDKIT: "1"
    bash: |
      echo "==> Build docker image..."
      docker build -t ttha .

  fmt:
    help: "Format source code"
    bash: |
      echo "==> Fixing source code with gofmt..."
      gofmt -s -w ./main.go ./meta.go ./cmd
